# 🚀 Guia Definitivo: Melhores Práticas Claude Code 2025

## 📋 Índice

1. [Fundamentos e Conceitos Essenciais](#fundamentos)
2. [Padrão agents.md: O Novo Standard da Indústria](#agents-md)
3. [Configuração e Setup Inicial](#setup)
4. [Workflows Avançados](#workflows)
5. [Subagentes: Arquitetura Multi-Agente](#subagentes)
6. [Hooks e Automação](#hooks)
7. [Comandos Customizados](#comandos)
8. [Gerenciamento de Contexto e Memória](#contexto)
9. [Modos de Operação: Plan Mode vs Agentic Mode](#modos)
10. [Integração com Ferramentas Externas](#integracao)
11. [Refatoração Segura e Iterativa](#refatoracao)
12. [Revisão de Pull Requests](#pr-review)
13. [Segurança e Boas Práticas](#seguranca)
14. [Troubleshooting e Otimização](#troubleshooting)
15. [Checklists e Referências Rápidas](#checklists)

---

## 1. Fundamentos e Conceitos Essenciais {#fundamentos}

### O que é Claude Code?

O Claude Code é uma ferramenta de assistência de codificação por IA desenvolvida pela Anthropic que atua como um "par programador" direto no seu fluxo de trabalho. Diferente de assistentes de código convencionais:

- **Executa ações reais**: cria arquivos, modifica código, executa testes
- **Opera via linha de comando ou IDE**: integração profunda com VS Code, Cursor e JetBrains
- **Gerencia projetos completos**: não apenas sugere trechos, mas implementa features inteiras
- **Possui 17+ ferramentas nativas**: readFile, runCommand, webSearch, task (subagentes), etc.

### Modelos Disponíveis

#### Claude 4 Sonnet
- ✅ **Recomendado para uso diário**
- ⚡ Mais rápido e estável
- 💰 ~1/5 do custo do Opus
- 🎯 Excelente para 95% das tarefas
- 📊 Supera GPT-4 em vários benchmarks

#### Claude 4 Opus
- 🧠 Máximo raciocínio e inteligência
- 🐢 5× mais lento que Sonnet
- 💸 5× mais caro que Sonnet
- ⚠️ Pode ter instabilidades de uptime
- 🎯 Use apenas para tarefas extremamente complexas

**Regra de Ouro**: Comece sempre com Sonnet. Só mude para Opus se:
- Sonnet falhou em resolver o problema
- Tarefa requer raciocínio arquitetural profundo
- Análise de código extremamente complexa

---

## 2. Padrão agents.md: O Novo Standard da Indústria {#agents-md}

### 🎯 Por que agents.md?

O `agents.md` é um **padrão aberto** proposto para substituir arquivos proprietários fragmentados:
- ❌ Antes: `.cursor-rules`, `claude.md`, `.copilot-instructions` (incompatíveis)
- ✅ Agora: `agents.md` (universal, suportado por OpenAI, Google Jules, Cursor)

**Status Atual (2025)**: 
- ✅ Adotado por: OpenAI, Google (Jules), Cursor, AMP Code
- ⏳ Pendente: Anthropic Claude, Gemini CLI

### 📝 Estrutura do agents.md

```markdown
# Project Overview
Brief description of what this project does and its main technologies.

## Tech Stack
- Frontend: React 18, Next.js 14
- Backend: Node.js, Express
- Database: PostgreSQL 14
- Testing: Jest, Playwright

## Environment Setup
1. Install Node.js v18+
2. Run: `npm install`
3. Copy `.env.example` to `.env`

## Build & Test Commands
### Build
```bash
npm run build
```

### Run Tests
```bash
# Run all tests - ALWAYS run after making changes
npm test

# Run specific test suite
npm test -- path/to/test
```

## Code Style Guidelines
- Use TypeScript strict mode
- Follow ESLint rules in `.eslintrc.js`
- Max line length: 100 characters
- Prefer functional components over class components

## Security Considerations
- Never commit secrets or API keys
- Sanitize all user inputs
- Use parameterized queries for database operations
- Validate environment variables on startup

## Commit Message Format
Follow Conventional Commits:
- `feat:` new feature
- `fix:` bug fix
- `docs:` documentation only
- `refactor:` code restructure without behavior change
```

### 🎯 Uso em Monorepos

Para projetos grandes, use **arquivos aninhados**:

```
/
├── agents.md                 # Regras globais
├── packages/
│   ├── api/
│   │   └── agents.md        # Regras específicas da API
│   └── frontend/
│       └── agents.md        # Regras específicas do frontend
```

**Precedência**: O arquivo mais próximo do código sendo editado sempre vence.

### ✅ Checklist de Migração

- [ ] Renomear arquivos existentes (`.cursor-rules` → `agents.md`)
- [ ] Adicionar comandos de teste obrigatórios
- [ ] Incluir setup de ambiente completo
- [ ] Documentar stack tecnológica
- [ ] Definir guidelines de segurança
- [ ] Versionar no Git junto com código

---

## 3. Configuração e Setup Inicial {#setup}

### 📦 Instalação

#### Via npm (Global)
```bash
npm install -g @anthropic-ai/claude-code
```

#### Via IDE (Recomendado)

**VS Code / Cursor**:
1. Abrir Extensions Marketplace
2. Buscar "Claude Code"
3. Instalar extensão oficial
4. Reiniciar IDE

**JetBrains IDEs**:
1. Settings → Plugins
2. Buscar "Claude Code"
3. Instalar e reiniciar

### 🔐 Autenticação

#### Opção 1: Conta Anthropic
```bash
claude  # Primeira execução abre login no navegador
```

#### Opção 2: API Key
```bash
# Linux/Mac
export ANTHROPIC_API_KEY="sk-ant-..."

# Windows (PowerShell)
$env:ANTHROPIC_API_KEY="sk-ant-..."

# Persistente (adicionar ao ~/.bashrc ou ~/.zshrc)
echo 'export ANTHROPIC_API_KEY="sk-ant-..."' >> ~/.bashrc
```

### 🎬 Inicialização de Projeto

```bash
cd /caminho/do/projeto
claude
```

**Primeiro comando SEMPRE**:
```bash
/init
```

O `/init` irá:
1. ✅ Analisar estrutura do projeto
2. ✅ Identificar dependências
3. ✅ Criar arquivo `.claude.md` (ou usar `agents.md` se existir)
4. ✅ Mapear tech stack
5. ✅ Preparar contexto inicial

### ⚙️ Configurações Recomendadas

#### .claude/settings.json
```json
{
  "diffView": "auto",
  "autoUpdate": false,
  "model": "claude-sonnet-4",
  "hooks": {},
  "customCommands": {}
}
```

**Dica**: Desativar `autoUpdate` evita surpresas com versões instáveis.

---

## 4. Workflows Avançados {#workflows}

### 🎯 Workflow 1: Spec-Driven Development

Este é o **workflow mais recomendado** para features complexas.

#### Fase 1: Planejamento
```bash
# Entrar em Plan Mode
Shift + Tab  # No Cursor/IDE

# Ou adicionar ao .claude.md:
```

Adicionar ao `.claude.md`:
```markdown
## Development Workflow
IMPORTANT: Before implementing ANY feature:
1. Create a detailed plan in a markdown file
2. Get approval from user
3. Only then proceed with implementation
```

#### Fase 2: Execução
```
> Crie um plano detalhado para implementar autenticação JWT
```

Claude Code irá:
1. Criar arquivo `auth-jwt-plan.md`
2. Detalhar fases de implementação
3. Identificar arquivos a modificar
4. Listar testes necessários

#### Fase 3: Implementação por Fases
```
> Vamos implementar a Fase 1: Configuração de dependências
```

### 🎯 Workflow 2: Multi-Agent Setup

**Use Case**: Projetos grandes onde diferentes agentes focam em áreas específicas.

#### Setup
```bash
# Terminal 1 - Backend Agent
claude
> Você é o Agent Backend. Foque apenas em API e banco de dados.

# Terminal 2 - Frontend Agent  
claude
> Você é o Agent Frontend. Foque apenas em componentes React.

# Terminal 3 - Testing Agent
claude
> Você é o Agent Testing. Foque apenas em testes e QA.
```

#### Arquivo de Comunicação: coms.md
```markdown
# Agent Communication Log

## Current Status
- Backend: Implementando endpoint /api/users
- Frontend: Aguardando API estar pronta
- Testing: Escrevendo testes unitários para UserService

## Completed Tasks
- [Backend] Setup database migrations
- [Backend] Created User model
- [Frontend] Created UserProfile component skeleton

## Blocked/Waiting
- [Frontend] Bloqueado: aguardando endpoint /api/users
```

**Instrução para cada agent**:
```
Antes de cada tarefa, leia coms.md. Após completar, atualize seu status no coms.md.
```

### 🎯 Workflow 3: Pull Request Review

#### Prompt Especializado

```markdown
This is the pull request I need you to review. Pay attention because this is 
a very important change. 

**PROCESS**:

**Stage 1 - Understanding**:
1. Execute: `gh pr view [PR_NUMBER]`
2. Read the title and description
3. Summarize: What is the PR trying to achieve?

**Stage 2 - Preparation**:
1. Execute: `gh pr checkout [PR_NUMBER]`
2. List all changed files
3. Note which parts of the system are affected

**Stage 3 - Manual Testing**:
1. Install dependencies if needed
2. Run the application
3. Test the new feature manually
4. Verify nothing broke

**Stage 4 - Code Analysis**:
For each file changed:
1. Open the file
2. Explain what changed and why
3. Identify potential issues:
   - Logic errors
   - Security vulnerabilities
   - Performance concerns
   - Missing error handling
   - Lack of tests

**Final Output**:
- Summary of changes
- List of concerns (if any)
- Recommendation: Approve / Request Changes / Needs Discussion

Answer in short but complete.
```

---

## 5. Subagentes: Arquitetura Multi-Agente {#subagentes}

### 🤖 O que são Subagentes?

Subagentes são **versões especializadas** do Claude Code que:
- ✅ Operam em **janela de contexto isolada**
- ✅ Possuem ferramentas específicas limitadas
- ✅ Retornam apenas resumo ao agente principal
- ✅ Podem ser reutilizados infinitas vezes

### 📊 Comparação: Subagentes vs Comandos Customizados

| Aspecto | Comandos Customizados | Subagentes |
|---------|----------------------|------------|
| Contexto | Compartilhado (polui) | Isolado (limpo) |
| Ferramentas | Todas disponíveis | Seletivas |
| Consumo de tokens | Alto | Otimizado |
| Reutilização | Sim | Sim |
| Segurança | Menor controle | Maior controle |

### 🎯 Criando um Subagente

```bash
/agents new
```

**Opções**:
1. **Project Agent**: Disponível apenas neste projeto
   - Salvo em `.claude/agents/`
2. **Personal Agent**: Disponível globalmente
   - Salvo em `~/.claude/agents/`

### 📝 Exemplo: ShadCN UI Builder

```markdown
# Agent Name
ShadCN UI Builder

# Description
Expert in building modern React UIs using ShadCN components and Next.js.
Automatically invoked when user asks for UI implementation with ShadCN.

# System Prompt
You are a specialized UI development agent. Your role:
1. Build React components using ShadCN UI library
2. Follow Next.js 14 app router conventions
3. Use Tailwind CSS for styling
4. Ensure accessibility (ARIA labels, keyboard navigation)
5. Create responsive designs (mobile-first)

## Workflow
1. Read design specs from provided file
2. Install necessary ShadCN components
3. Create component structure
4. Implement functionality
5. Add proper TypeScript types
6. Write brief usage documentation

## Constraints
- NEVER modify files outside /components or /app directories
- ALWAYS use TypeScript strict mode
- MUST include responsive breakpoints

# Tools Allowed
[x] readFile
[x] writeFile
[x] runCommand
[ ] webSearch (not needed)
[ ] deleteFile (too dangerous)
```

### 🔄 Invocando Subagentes

#### Automática (Baseada em Descrição)
```
> Crie uma página de dashboard usando componentes ShadCN
```
→ Claude Code automaticamente detecta e ativa "ShadCN UI Builder"

#### Manual (Explícita)
```
> @ShadCN-UI-Builder implemente a tela de login
```

### 🔗 Encadeamento de Subagentes

**Use Case**: Workflow complexo multi-etapa

#### Criar Comando Customizado
`.cloud/commands/full-feature.md`:
```markdown
Execute this workflow:

1. Call @Code-Analyzer to analyze the current codebase
2. Wait for analysis completion
3. Call @Feature-Implementer with the analysis results
4. Wait for implementation
5. Call @Test-Writer to create tests for new code
6. Run all tests
7. If tests pass, call @Documenter to update documentation
```

Uso:
```bash
/full-feature implement user authentication
```

---

## 6. Hooks e Automação {#hooks}

### 🎯 O que são Hooks?

Hooks permitem **executar ações automáticas** quando eventos específicos ocorrem:

- `pre-tool-use`: Antes de executar qualquer ferramenta
- `post-tool-use`: Após usar uma ferramenta
- `on-stop`: Quando tarefa é concluída
- `on-error`: Quando ocorre um erro

### 🔧 Configurando Hooks

#### Via Interface
```bash
/hooks
```

#### Via JSON (`.claude/settings.json`)
```json
{
  "hooks": {
    "post-tool-use": [
      {
        "matcher": "Write|Edit|MultiEdit",
        "hooks": [
          {
            "type": "command",
            "command": "python3 .claude/hooks/typecheck.py"
          }
        ]
      }
    ],
    "on-stop": [
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "command",
            "command": "afplay /System/Library/Sounds/Glass.aiff"
          }
        ]
      }
    ]
  }
}
```

### 📝 Exemplo: Type Check Automático

`.claude/hooks/typecheck.py`:
```python
#!/usr/bin/env python3
import sys
import json
import subprocess

# Receber dados do hook via stdin
hook_data = json.load(sys.stdin)
tool_output = hook_data.get('tool_output', {})
files = tool_output.get('files', [])

# Verificar cada arquivo TypeScript modificado
for file_path in files:
    if file_path.endswith(('.ts', '.tsx')):
        result = subprocess.run(
            ['npx', 'tsc', '--noEmit', '--strict', file_path],
            capture_output=True,
            text=True
        )
        
        if result.returncode != 0:
            print(f"❌ Type check failed for {file_path}:", file=sys.stderr)
            print(result.stderr, file=sys.stderr)
            sys.exit(2)  # Exit code 2 = bloqueio

print("✅ All type checks passed")
sys.exit(0)
```

Tornar executável:
```bash
chmod +x .claude/hooks/typecheck.py
```

### 🎯 Hook: Notificação Sonora

#### macOS
```json
{
  "hooks": {
    "on-stop": [{
      "matcher": "*",
      "hooks": [{
        "type": "command",
        "command": "afplay /System/Library/Sounds/Glass.aiff"
      }]
    }]
  }
}
```

#### Linux
```bash
paplay /usr/share/sounds/freedesktop/stereo/complete.oga
```

#### Windows (PowerShell)
```powershell
[console]::beep(800,300)
```

### ⚡ Hooks Avançados

#### Auto-formatter
```json
{
  "hooks": {
    "post-tool-use": [
      {
        "matcher": "Write|Edit",
        "hooks": [
          {
            "type": "command",
            "command": "npm run format"
          }
        ]
      }
    ]
  }
}
```

#### Security Scan
```json
{
  "hooks": {
    "post-tool-use": [
      {
        "matcher": "Write",
        "hooks": [
          {
            "type": "command",
            "command": "semgrep --config auto ."
          }
        ]
      }
    ]
  }
}
```

---

## 7. Comandos Customizados {#comandos}

### 🎯 Criando Comandos

**Estrutura**:
```
.cloud/
└── commands/
    ├── analyze.md
    ├── optimize.md
    └── joke.md
```

### 📝 Exemplo 1: Análise de Código

`.cloud/commands/analyze.md`:
```markdown
Execute a deep code analysis of the current file:

1. **Complexity Analysis**:
   - Identify functions with cyclomatic complexity > 10
   - Flag deeply nested code (> 4 levels)
   - Detect long functions (> 50 lines)

2. **Code Quality**:
   - Check for code duplication
   - Identify magic numbers and hard-coded values
   - Look for missing error handling

3. **Performance Concerns**:
   - Spot potential performance bottlenecks
   - Identify inefficient algorithms
   - Check for unnecessary re-renders (React)

4. **Security Issues**:
   - Look for SQL injection vulnerabilities
   - Check for XSS vulnerabilities
   - Identify exposed secrets or API keys

Provide actionable recommendations with code examples.
```

Uso:
```bash
/analyze
```

### 📝 Exemplo 2: Gerador de Testes

`.cloud/commands/test-gen.md`:
```markdown
Generate comprehensive unit tests for the current file:

1. **Test Structure**:
   - Use Jest/Vitest framework
   - Follow AAA pattern (Arrange, Act, Assert)
   - One test file per source file

2. **Coverage Goals**:
   - Test all public functions
   - Include edge cases (empty input, null, undefined)
   - Test error scenarios
   - Mock external dependencies

3. **Test Quality**:
   - Use descriptive test names
   - Keep tests isolated (no shared state)
   - Avoid testing implementation details

4. **Output**:
   - Create test file with `.test.ts` or `.spec.ts` extension
   - Place in `__tests__` directory or alongside source file
```

### 📝 Exemplo 3: Documentação Automática

`.cloud/commands/doc-gen.md`:
```markdown
Generate comprehensive documentation for the current code:

1. **JSDoc Comments**:
   - Add JSDoc to all functions
   - Include @param, @returns, @throws
   - Add examples for complex functions

2. **README Section**:
   - Create usage example
   - List dependencies
   - Explain main concepts

3. **Inline Comments**:
   - Add comments for complex logic
   - Explain WHY, not WHAT
   - Keep comments up to date with code
```

### 🔥 Pacote: Supercloud

Instalar:
```bash
npm install -g @supercloud/cli
```

Comandos disponíveis:
- `/sc-analyze`: Análise profunda de arquitetura
- `/workflow`: Segue um PRD passo a passo
- `/optimize`: Sugestões de otimização
- `/security`: Scan de vulnerabilidades

---

## 8. Gerenciamento de Contexto e Memória {#contexto}

### 📁 Arquivo de Contexto: .claude.md

O `.claude.md` (ou `agents.md`) é o **cérebro persistente** do projeto.

```markdown
# Project Context

## Tech Stack
- Next.js 14 (App Router)
- React 18
- TypeScript 5
- Tailwind CSS
- PostgreSQL
- Prisma ORM

## Key Decisions
- Using Server Components by default
- API routes only for external webhooks
- Database queries via Prisma Client Extensions

## Active Constraints
- Max bundle size: 200KB per route
- All components must be fully typed
- No inline styles (use Tailwind only)

## Common Patterns
### API Error Handling
```typescript
try {
  // operation
} catch (error) {
  return NextResponse.json(
    { error: error.message },
    { status: 500 }
  )
}
```

## Important Files
- `/lib/db.ts`: Database connection
- `/lib/auth.ts`: Authentication logic
- `/app/api/*/route.ts`: API endpoints
```

### 🔄 Comandos de Contexto

#### Resumir Conversa Longa
```bash
/compact
```
Gera sumário e libera espaço no contexto.

#### Retomar Sessão
```bash
/resume <nome-ou-id>
```

#### Ver Histórico
```bash
/history
```

#### Limpar Contexto
```bash
/clear
```
⚠️ **Atenção**: Apaga histórico, mas mantém `.claude.md`

### 💾 Modo Memória

#### Sintaxe
```bash
# Este é um comentário de memória
# A IA lembrará disso nas próximas interações
# Versão da API atual: v2.1
```

#### Uso Prático
```bash
# Usuário prefere código verboso e bem comentado
# Sempre usar async/await ao invés de .then()
# Priorizar performance sobre legibilidade neste projeto
```

### 🧠 Limites de Contexto

| Modelo | Janela de Contexto | Uso Recomendado |
|--------|-------------------|------------------|
| Sonnet 4 | ~100K tokens | 95% dos casos |
| Opus 4 | ~100K tokens | Tarefas complexas |

**1 token ≈ 0.75 palavras**
**100K tokens ≈ 75K palavras ≈ 300 páginas**

---

## 9. Modos de Operação: Plan Mode vs Agentic Mode {#modos}

### 📋 Plan Mode (Planejamento)

#### Ativação
- **Cursor**: `Shift + Tab`
- **CLI**: Adicionar regra ao `.claude.md`

```markdown
## Workflow Rule
CRITICAL: For ANY new feature:
1. First create a detailed plan
2. Save plan to `plans/<feature-name>.md`
3. Wait for user approval
4. Only then implement
```

#### Comportamento
- 🔍 Prioriza pesquisa e análise
- 📝 Cria especificações detalhadas
- ❌ **NÃO** executa comandos destrutivos
- ✅ Gera planos em Markdown

#### Quando Usar
- ✅ Início de features complexas
- ✅ Refatorações grandes
- ✅ Arquitetura de novos módulos
- ✅ Análise de problemas difíceis

### ⚡ Agentic Mode (Execução)

#### Ativação
- Modo padrão após sair do Plan Mode
- Ou comando: `/autoapprove`

#### Comportamento
- 🚀 Executa ações automaticamente
- 📝 Modifica arquivos
- 🔧 Roda comandos
- ✅ Implementa código

#### Quando Usar
- ✅ Após plano aprovado
- ✅ Tarefas bem definidas
- ✅ Implementações diretas
- ✅ Ajustes menores

### 🔄 Workflow Recomendado

```
1. [Plan Mode] → Criar plano detalhado
2. [Humano]    → Revisar e aprovar plano
3. [Agentic]   → Implementar Fase 1
4. [Humano]    → Testar Fase 1
5. [Agentic]   → Implementar Fase 2
6. [Humano]    → Testar Fase 2
... repetir até conclusão
```

---

## 10. Integração com Ferramentas Externas {#integracao}

### 🔌 MCP (Model Context Protocol)

#### Conectar GitHub
```bash
/mcp add github
```

Configurar:
```json
{
  "mcpServers": {
    "github": {
      "command": "npx",
      "args": ["-y", "@modelcontextprotocol/server-github"],
      "env": {
        "GITHUB_PERSONAL_ACCESS_TOKEN": "ghp_..."
      }
    }
  }
}
```

#### Conectar Google Drive
```bash
/mcp add google-drive
```

### 🎨 Cursor IDE

**Vantagens**:
- ✅ Atalho rápido: `Ctrl+Esc` (Windows) / `Cmd+Esc` (Mac)
- ✅ Visual diff integrado
- ✅ Compartilhamento automático de seleção
- ✅ Max Mode (contexto gigante)

**Setup**:
1. Instalar Cursor IDE
2. Instalar extensão Claude Code
3. Abrir projeto
4. `Ctrl+Esc` para ativar

### 🗣️ SuperWhisper (Speech-to-Text)

**Use Case**: Ditar prompts longos por voz

Setup:
1. Instalar SuperWhisper
2. Configurar hotkey global
3. Falar → transcrição automática → envio ao Claude

### 🔁 cc undo (Versionamento)

**Problema**: Claude Code não tem "undo" nativo

**Solução**: Pacote `cc undo`

```bash
npm install -g cc-undo
```

Uso:
```bash
# Listar alterações
cc undo list

# Preview de mudança
cc undo preview <id>

# Desfazer alteração
cc undo apply <id>
```

---

## 11. Refatoração Segura e Iterativa {#refatoracao}

### 🎯 Metodologia: 3 Fases Cirúrgicas

#### Fase 1: Safety Net (Rede de Segurança)
```bash
> Antes de qualquer refatoração deste arquivo:
> 1. Crie testes abrangentes cobrindo TODA funcionalidade existente
> 2. Execute os testes e garanta 100% de passa
> 3. Documente o comportamento atual
> 4. Só então me avise que podemos prosseguir
```

**Objetivo**: Garantir que podemos detectar qualquer quebra.

#### Fase 2: Surgical Planning (Planejamento Cirúrgico)
```bash
> Analise o código e:
> 1. Identifique "hotspots" de complexidade (funções > 50 linhas, alta cyclomatic complexity)
> 2. Ranqueie por risco: menor → maior
> 3. Crie um plano de extração em ordem de risco crescente
> 4. Para cada item, explique COMO será extraído e ONDE irá
```

**Output esperado**: `refactor-plan.md` com ordem de execução.

#### Fase 3: Incremental Execution (Execução Incremental)
```bash
> Execute o plano item por item:
> 1. Extraia apenas 40-60 linhas por vez
> 2. Após cada extração:
>    - Execute TODOS os testes
>    - Se falhar, REVERTA e tente abordagem diferente
>    - Se passar, commite a mudança
> 3. Continue para próximo item
```

### 📋 Exemplo Completo

**Arquivo original**: `UserService.ts` (1200 linhas, complexidade 47)

```typescript
// Phase 1: Safety Net
> Crie testes completos para UserService.ts

// Phase 2: Planning
> Crie plano de refatoração para UserService.ts

// Output: refactor-plan.md
```

```markdown
# UserService Refactoring Plan

## Risk Assessment
- Total Lines: 1200
- Cyclomatic Complexity: 47
- Dependencies: 23

## Extraction Order (Low→High Risk)

### 1. Validation Functions (Low Risk)
**Lines**: 45-120
**Complexity**: 8
**Target**: `validators/user-validator.ts`
**Dependencies**: None
**Tests**: Isolated, easy to test

### 2. Database Queries (Medium Risk)
**Lines**: 200-350
**Complexity**: 15
**Target**: `repositories/user-repository.ts`
**Dependencies**: Prisma client
**Tests**: Requires DB mocks

### 3. Business Logic (High Risk)
**Lines**: 400-800
**Complexity**: 24
**Target**: `services/user-business-logic.ts`
**Dependencies**: Multiple services
**Tests**: Complex integration tests
```

```typescript
// Phase 3: Execution
> Execute item 1 do plano de refatoração

// Após cada extração:
> Execute npm test e me informe resultados
```

### ✅ Checklist de Refatoração

- [ ] Testes existentes passando 100%
- [ ] Nova estrutura de arquivos definida
- [ ] Plano de extração em ordem de risco
- [ ] Cada extração ≤ 60 linhas
- [ ] Testes executados após cada passo
- [ ] Commits pequenos e frequentes
- [ ] Documentação atualizada

---

## 12. Revisão de Pull Requests {#pr-review}

### 🎯 Template de Prompt

```markdown
# PR Review Process

This PR: #[NUMBER]

## Stage 1: Understanding (5 min)
Execute:
```bash
gh pr view [NUMBER]
gh pr diff [NUMBER]
```

Questions:
1. What is the main purpose of this PR?
2. Which parts of the system are affected?
3. Are there any breaking changes?

## Stage 2: Checkout & Build (5 min)
```bash
gh pr checkout [NUMBER]
npm install
npm run build
```

Verify:
- [ ] Build succeeds without errors
- [ ] No new warnings

## Stage 3: Manual Testing (10 min)
1. Start application
2. Test new functionality
3. Test existing functionality (regression)
4. Check edge cases

Document findings:
- What works as expected?
- What doesn't work?
- Any unexpected behavior?

## Stage 4: Code Analysis (15 min)

For EACH changed file:

### Code Quality
- Is code readable and maintainable?
- Are there complex functions that should be split?
- Is there code duplication?

### Logic & Correctness
- Does the logic make sense?
- Are there edge cases not handled?
- Could this fail in production?

### Performance
- Are there inefficient operations?
- Could this cause memory leaks?
- Are database queries optimized?

### Security
- Is user input sanitized?
- Are there SQL injection risks?
- Are secrets properly managed?

### Testing
- Are there unit tests?
- Do tests cover edge cases?
- Are integration tests needed?

## Final Report

### Summary
[Brief description of changes]

### Strengths
- [What was done well]

### Concerns
1. [Critical issues to fix]
2. [Important issues to consider]
3. [Nice-to-have improvements]

### Recommendation
[ ] ✅ Approve
[ ] 🔄 Request Changes
[ ] 💬 Needs Discussion

### Next Steps
[What should happen next]
```

### 🚀 Uso Rápido

```bash
# Salvar template em comando
# .cloud/commands/review-pr.md

# Usar
/review-pr 1234
```

---

## 13. Segurança e Boas Práticas {#seguranca}

### 🔐 Princípios Fundamentais

#### 1. Nunca Commitar Secrets
```markdown
# Adicionar ao .claude.md ou agents.md

## SECURITY RULES - CRITICAL

❌ NEVER commit:
- API keys
- Database passwords
- JWT secrets
- OAuth tokens
- Private keys

✅ ALWAYS use:
- Environment variables (.env)
- Secret management services
- .gitignore for sensitive files
```

#### 2. Validar Entrada do Usuário
```typescript
// Exemplo de validação segura
import { z } from 'zod';

const userSchema = z.object({
  email: z.string().email(),
  age: z.number().min(18).max(120),
  username: z.string().min(3).max(50).regex(/^[a-zA-Z0-9_]+$/)
});

// Usar em handlers
try {
  const validated = userSchema.parse(input);
} catch (error) {
  return { error: 'Invalid input' };
}
```

#### 3. Sanitizar Queries SQL
```typescript
// ❌ PERIGOSO
const query = `SELECT * FROM users WHERE email = '${email}'`;

// ✅ SEGURO
const user = await db.user.findUnique({
  where: { email }
});
```

### 🛡️ Configurar Hooks de Segurança

`.claude/hooks/security-scan.sh`:
```bash
#!/bin/bash

echo "🔍 Running security scan..."

# Check for hardcoded secrets
if grep -r "API_KEY\s*=\s*['\"]" . --exclude-dir=node_modules; then
    echo "❌ Found hardcoded API key!"
    exit 2
fi

# Check for SQL injection patterns
if grep -r "SELECT.*FROM.*WHERE.*\${" . --include="*.ts" --include="*.js"; then
    echo "❌ Potential SQL injection found!"
    exit 2
fi

# Run Semgrep
npx semgrep --config auto . --quiet

echo "✅ Security scan passed"
exit 0
```

Configurar hook:
```json
{
  "hooks": {
    "post-tool-use": [{
      "matcher": "Write|Edit",
      "hooks": [{
        "type": "command",
        "command": ".claude/hooks/security-scan.sh"
      }]
    }]
  }
}
```

### 🔒 Permissões Granulares

**Princípio do Menor Privilégio**:
```bash
# Ao criar subagente, desmarcar ferramentas não necessárias
/agents new

# Desmarcar:
[ ] deleteFile     # Muito destrutivo
[ ] runCommand     # Se não precisa executar shell
[ ] webSearch      # Se trabalha apenas localmente
```

### 📋 Checklist de Segurança

- [ ] Nenhum secret commitado
- [ ] `.env` no `.gitignore`
- [ ] Validação de input em todos endpoints
- [ ] Queries parametrizadas (sem string concatenation)
- [ ] HTTPS em todas APIs externas
- [ ] Rate limiting implementado
- [ ] Logs não expõem dados sensíveis
- [ ] Dependências atualizadas (sem vulnerabilidades conhecidas)

---

## 14. Troubleshooting e Otimização {#troubleshooting}

### 🐛 Problemas Comuns

#### Problema 1: "Context window exceeded"

**Sintomas**:
- Erro ao enviar prompt longo
- Modelo para de responder

**Soluções**:
```bash
# 1. Compactar histórico
/compact

# 2. Limpar contexto e recomeçar
/clear

# 3. Usar subagentes para tarefas específicas
/agents new

# 4. Dividir tarefa em etapas menores
> Faça apenas a Fase 1 por enquanto
```

#### Problema 2: Código gerado não funciona

**Diagnóstico**:
```bash
# Ver detalhes da execução
Ctrl + R  # Expande log de ações
```

**Soluções**:
```bash
# 1. Fornecer mais contexto
> Revise o código considerando que usamos Next.js 14 App Router

# 2. Pedir análise de erro
> Por que este código falhou? Analise o erro: [colar erro]

# 3. Refazer de forma iterativa
> Refaça apenas a função X, mantendo o resto intacto
```

#### Problema 3: IA modifica arquivos errados

**Prevenção**:
```markdown
# Adicionar ao .claude.md

## CRITICAL CONSTRAINTS

You MUST ONLY modify files in:
- /src
- /components  
- /lib

You MUST NEVER modify:
- /node_modules
- /.git
- /build
- /dist
- Any test fixtures in /__mocks__
```

**Recuperação**:
```bash
# Usar cc undo
cc undo list
cc undo apply <id>

# Ou Git
git status
git checkout -- <arquivo>
```

#### Problema 4: Performance lenta

**Causas**:
- Modelo Opus (mais lento)
- Projeto muito grande
- Muitos arquivos no contexto

**Soluções**:
```bash
# 1. Mudar para Sonnet
/model sonnet

# 2. Limitar escopo
> Trabalhe apenas nos arquivos em /src/auth

# 3. Usar .claudeignore
# Criar .claudeignore (similar ao .gitignore)
node_modules/
dist/
*.log
*.lock
```

### ⚡ Otimizações de Performance

#### 1. .claudeignore Bem Configurado
```
# Dependencies
node_modules/
vendor/

# Build outputs
dist/
build/
.next/
out/

# Logs
*.log
logs/

# Lock files
package-lock.json
yarn.lock
pnpm-lock.yaml

# OS files
.DS_Store
Thumbs.db

# IDE
.vscode/
.idea/

# Large assets
*.mp4
*.mov
*.zip
*.tar.gz
```

#### 2. Usar Task para Arquivos Grandes
```bash
> Use a ferramenta task para ler o arquivo logs/production.log 
> e me diga se há erros relacionados a autenticação
```

Isso cria um subagente que:
- Lê o arquivo isoladamente
- Retorna apenas resumo relevante
- Não polui contexto principal

#### 3. Prompt Caching
```bash
# Reusar prompts comuns
# Claude API automaticamente cacheia prompts repetidos
# Reduz latência em 50-80%
```

---

## 15. Checklists e Referências Rápidas {#checklists}

### ✅ Checklist: Novo Projeto

- [ ] Instalar Claude Code (`npm install -g @anthropic-ai/claude-code`)
- [ ] Autenticar (API key ou login Anthropic)
- [ ] Criar `agents.md` na raiz
- [ ] Executar `/init`
- [ ] Configurar hooks de segurança
- [ ] Criar `.claudeignore`
- [ ] Adicionar comando `/review-pr`
- [ ] Configurar subagentes especializados
- [ ] Testar workflow de desenvolvimento
- [ ] Documentar padrões da equipe

### ✅ Checklist: Nova Feature

- [ ] Criar issue/ticket descrevendo feature
- [ ] Ativar Plan Mode (`Shift + Tab`)
- [ ] Gerar plano detalhado
- [ ] Revisar e aprovar plano
- [ ] Implementar Fase 1
- [ ] Testar Fase 1
- [ ] Commit Fase 1
- [ ] Repetir para cada fase
- [ ] Code review (humano ou `/review-pr`)
- [ ] Merge para main

### ✅ Checklist: Refatoração

- [ ] Criar branch de refatoração
- [ ] Executar Fase 1: Safety Net (testes)
- [ ] Executar Fase 2: Surgical Planning
- [ ] Revisar plano de refatoração
- [ ] Executar Fase 3: Incremental Execution
- [ ] Verificar testes após cada passo
- [ ] Commit após cada extração bem-sucedida
- [ ] Code review final
- [ ] Merge

### 📋 Comandos Essenciais - Referência Rápida

```bash
# Inicialização
/init                    # Analisar projeto
/ide                     # Conectar ao IDE

# Contexto
/clear                   # Limpar histórico
/compact                 # Resumir conversa
/resume <id>             # Retomar sessão

# Modelos
/model sonnet           # Mudar para Sonnet
/model opus             # Mudar para Opus

# Configuração
/config                  # Abrir configurações
/hooks                   # Gerenciar hooks
/agents                  # Gerenciar subagentes
/mcp                     # Gerenciar MCPs

# Execução
!<comando>              # Bash mode (executar shell)
#<texto>                # Memory mode (memorizar)

# Navegação
↑ (seta cima)           # Histórico de prompts
Esc                      # Interromper execução
Ctrl+R                   # Expandir log detalhado
Shift+Tab                # Toggle Plan Mode
```

### 🎯 Atalhos de Teclado (Cursor IDE)

| Atalho | Ação |
|--------|------|
| `Ctrl+Esc` / `Cmd+Esc` | Abrir Claude Code |
| `Shift+Tab` | Toggle Plan/Agentic Mode |
| `Alt+Ctrl+K` | Adicionar arquivo como referência |
| `Esc` | Cancelar operação |
| `↑` / `↓` | Navegar histórico |
| `Ctrl+R` | Expandir detalhes |

### 📚 Recursos Importantes

#### Documentação Oficial
- [Claude Code Overview](https://docs.anthropic.com/en/docs/claude-code/overview)
- [Quickstart Guide](https://docs.anthropic.com/en/docs/claude-code/quickstart)
- [CLI Reference](https://docs.anthropic.com/en/docs/claude-code/cli-reference)
- [Hooks Documentation](https://docs.anthropic.com/en/docs/claude-code/hooks)

#### Padrões e Especificações
- [agents.md Standard](https://agents.md.def)
- [MCP Protocol](https://modelcontextprotocol.io)

#### Ferramentas Complementares
- [Cursor IDE](https://cursor.sh)
- [Claudia UI](https://github.com/saoudrizwan/claude-dev)
- [Supercloud](https://github.com/supercloudhq/supercloud)
- [cc-undo](https://github.com/cyanheads/cc-undo)
- [SuperWhisper](https://superwhisper.com)

---

## 🎓 Conclusão e Próximos Passos

### 🚀 Caminho de Aprendizado

**Nível 1: Básico (Semana 1)**
- ✅ Instalação e setup
- ✅ Comandos básicos (`/init`, `/clear`, `!comando`)
- ✅ Criar primeiro `agents.md`
- ✅ Implementar feature simples

**Nível 2: Intermediário (Semana 2-3)**
- ✅ Configurar hooks (type check, linter)
- ✅ Criar comandos customizados
- ✅ Usar Plan Mode consistentemente
- ✅ Workflow de PR review

**Nível 3: Avançado (Mês 1-2)**
- ✅ Criar e usar subagentes
- ✅ Multi-agent setup
- ✅ Refatoração cirúrgica
- ✅ Integração com MCP servers

**Nível 4: Expert (Mês 3+)**
- ✅ Encadeamento de subagentes
- ✅ Workflows complexos automatizados
- ✅ Contribuir com padrões da comunidade
- ✅ Criar ferramentas e extensões próprias

### 💡 Dicas Finais

1. **Comece simples**: Não tente implementar tudo de uma vez
2. **Documente seu processo**: Compartilhe aprendizados com a equipe
3. **Itere constantemente**: Refine seus prompts e workflows
4. **Mantenha segurança em mente**: Revise sempre o código gerado
5. **Aprenda com a comunidade**: GitHub, Discord, Reddit

### 🤝 Contribuindo

Este guia é um documento vivo. Para contribuir:
- Abra issues com sugestões
- Compartilhe seus workflows
- Reporte erros ou desatualizações
- Sugira novos tópicos

---

**Última atualização**: Outubro 2025
**Versão**: 1.0
**Licença**: CC BY-SA 4.0

---

*Desenvolvido com ❤️ pela comunidade Claude Code*